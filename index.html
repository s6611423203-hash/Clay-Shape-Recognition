<!DOCTYPE html>
<html lang="th">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>AI ‡∏ó‡∏≤‡∏¢‡∏á‡∏≤‡∏ô‡∏õ‡∏±‡πâ‡∏ô‡∏î‡∏¥‡∏ô‡∏ô‡πâ‡∏≥‡∏°‡∏±‡∏ô‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö‡πÄ‡∏î‡πá‡∏Å</title>
  <meta name="description" content="‡πÄ‡∏Å‡∏°‡∏™‡πÅ‡∏Å‡∏ô‡∏á‡∏≤‡∏ô‡∏õ‡∏±‡πâ‡∏ô‡∏î‡∏¥‡∏ô‡∏ô‡πâ‡∏≥‡∏°‡∏±‡∏ô‡∏î‡πâ‡∏ß‡∏¢‡∏Å‡∏•‡πâ‡∏≠‡∏á‡∏´‡∏£‡∏∑‡∏≠‡∏≠‡∏±‡∏õ‡πÇ‡∏´‡∏•‡∏î‡∏£‡∏π‡∏õ ‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö‡πÄ‡∏î‡πá‡∏Å‡∏≠‡∏ô‡∏∏‡∏ö‡∏≤‡∏•" />
  <script src="https://cdn.jsdelivr.net/npm/@tensorflow/tfjs@4.16.0/dist/tf.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/@teachablemachine/image@0.8/dist/teachablemachine-image.min.js"></script>
  <link href="https://fonts.googleapis.com/icon?family=Material+Icons" rel="stylesheet">
  <link rel="icon" type="image/png" href="CSR.png">
  <link href="https://fonts.googleapis.com/css2?family=Kanit:wght@400;700;900&display=swap" rel="stylesheet">

  <style>
  :root {
    /* ‡∏õ‡∏£‡∏±‡∏ö‡∏™‡∏µ‡πÉ‡∏´‡πâ‡∏™‡∏î‡πÉ‡∏™‡πÅ‡∏•‡∏∞‡∏î‡∏π‡πÄ‡∏õ‡πá‡∏ô‡∏°‡∏¥‡∏ï‡∏£‡∏Å‡∏±‡∏ö‡πÄ‡∏î‡πá‡∏Å‡∏°‡∏≤‡∏Å‡∏Ç‡∏∂‡πâ‡∏ô */
    --bg-gradient: linear-gradient(135deg, #FFC0CB, #ADD8E6, #90EE90); /* ‡∏ä‡∏°‡∏û‡∏π‡∏≠‡πà‡∏≠‡∏ô, ‡∏ü‡πâ‡∏≤‡∏≠‡πà‡∏≠‡∏ô, ‡πÄ‡∏Ç‡∏µ‡∏¢‡∏ß‡∏≠‡πà‡∏≠‡∏ô */
    --fg: #333333; 
    --muted: #6A6A6A;
    --card: rgba(255,255,255,0.95); 
    --accent: #FF69B4; /* ‡∏ä‡∏°‡∏û‡∏π‡∏™‡∏î */
    --ok: #3CB371; /* ‡πÄ‡∏Ç‡∏µ‡∏¢‡∏ß‡∏™‡∏î */
    --warn: #FFA500; /* ‡∏™‡πâ‡∏° */
    --err: #FF4500; /* ‡πÅ‡∏î‡∏á‡∏™‡πâ‡∏° */
    --ring: #DDDDDD;
  }

  body {
    margin: 0;
    font-family: 'Kanit', ui-sans-serif, system-ui; /* ‡πÉ‡∏ä‡πâ‡∏ü‡∏≠‡∏ô‡∏ï‡πå‡∏ó‡∏µ‡πà‡∏≠‡πà‡∏≤‡∏ô‡∏á‡πà‡∏≤‡∏¢ */
    background: var(--bg-gradient);
    background-attachment: fixed;
    color: var(--fg);
    font-size: 18px; /* ‡πÄ‡∏û‡∏¥‡πà‡∏°‡∏Ç‡∏ô‡∏≤‡∏î‡∏ü‡∏≠‡∏ô‡∏ï‡πå‡∏û‡∏∑‡πâ‡∏ô‡∏ê‡∏≤‡∏ô */
  }

  header { max-width: 960px; margin: 24px auto 0; padding: 0 16px; }
  .title.center { display: flex; flex-direction: column; align-items: center; text-align: center; }
  .logo { width: 120px; height: 120px; border-radius: 20px; overflow: hidden; display: flex; align-items: center; justify-content: center; margin-bottom: 10px; }
  .logo img { max-width: 100%; max-height: 100%; object-fit: contain; }
  h1 { 
    font-size: clamp(30px, 6vw, 45px); 
    margin: 0; 
    color: var(--accent); 
    font-weight: 900;
  }
  p.sub { 
    color: var(--fg); 
    margin: 8px 0 16px; 
    font-size: 1.2em;
    font-weight: bold;
  }

  main { max-width: 960px; margin: 20px auto 56px; padding: 0 16px; }
  .card { 
    background: var(--card); 
    border: 1px solid var(--ring); 
    border-radius: 30px; 
    padding: 30px; 
    box-shadow: 0 12px 30px rgba(0,0,0,.15); 
    backdrop-filter: blur(5px); 
    margin-bottom: 25px; 
  }
  .row { display: grid; gap: 20px; }
  @media (min-width: 900px) { .row { grid-template-columns: 1.2fr .8fr; } }

  .controls { display: flex; flex-wrap: wrap; gap: 15px; margin: 10px 0 15px; justify-content: center; }
  .btn { 
    appearance: none; border: none; background: #fff; color: var(--fg); 
    padding: 15px 24px; 
    border-radius: 20px; 
    cursor: pointer; transition: .2s; 
    box-shadow: 0 5px 15px rgba(0,0,0,.1);
    font-size: 1.1em; 
    font-weight: bold;
    display: flex; align-items: center; gap: 6px;
  }
  .btn:hover { transform: translateY(-3px) scale(1.03); }
  .btn.primary { background: var(--accent); color: #fff; }
  .btn.good { background: var(--ok); color: #fff; }
  .btn.warn { background: var(--warn); color: #fff; }
  .hidden { display: none!important; }
  .btn:disabled { opacity: 0.6; cursor: not-allowed; transform: none; box-shadow: none; }

  .previewBox { 
    background: rgba(255,255,255,0.9); 
    border: 4px dashed var(--accent); 
    border-radius: 20px; 
    min-height: 400px; 
    display: grid; 
    place-items: center; 
    overflow: hidden; 
  }
  video, img { max-width: 100%; height: auto; display: block; border-radius: 16px; }

  .status { font-size: 1.1em; color: var(--muted); font-weight: bold; }
  .result { 
    background: rgba(255,255,255,0.9); 
    border: 1px solid var(--ring); 
    border-radius: 20px; 
    padding: 20px; 
    box-shadow: 0 3px 10px rgba(0,0,0,.05); 
  }
  #top1 {
    font-size: 1.5em; 
    color: var(--accent);
    font-weight: 900;
    margin-top: 10px;
  }
  .pred { display: flex; align-items: center; justify-content: space-between; gap: 10px; margin: 10px 0; font-size: 1.1em; } 
  .bar { height: 15px; background: #f3f4f6; border-radius: 999px; overflow: hidden; flex: 1; margin: 0 10px; }
  .bar > span { display: block; height: 100%; background: var(--accent); width: 0%; }
  
  .foot { max-width: 960px; margin: 10px auto 32px; padding: 0 16px; color: var(--muted); font-size: 14px; text-align: center; }
  .note { padding: 15px; border-left: 6px solid var(--accent); background: #fdf2f8; border-radius: 10px; font-weight: bold; }
  .danger { border-left-color: var(--err); background: #fef2f2; }
  .ok { border-left-color: var(--ok); background: #ecfdf5; }
  #feedback { 
    font-size: 1.2em; 
    font-weight: bold; 
    color: var(--err); 
    min-height: 1.5em; /* ‡∏õ‡πâ‡∏≠‡∏á‡∏Å‡∏±‡∏ô‡∏Å‡∏≤‡∏£‡∏Å‡∏£‡∏∞‡πÇ‡∏î‡∏î‡∏Ç‡∏≠‡∏á Layout */
  }
  </style>
</head>
<body>
  <header>
    <div class="title center">
      <div class="logo"><img src="CSR.png" alt="CSR Logo"></div>
      <div>
        <h1>‚ú® AI ‡∏ó‡∏≤‡∏¢‡∏á‡∏≤‡∏ô‡∏õ‡∏±‡πâ‡∏ô‡∏î‡∏¥‡∏ô‡∏ô‡πâ‡∏≥‡∏°‡∏±‡∏ô! ‚ú®</h1>
        <p class="sub">‡∏ñ‡πà‡∏≤‡∏¢‡∏£‡∏π‡∏õ üì∏ ‡∏´‡∏£‡∏∑‡∏≠ ‡∏≠‡∏±‡∏õ‡πÇ‡∏´‡∏•‡∏î‡∏†‡∏≤‡∏û üñºÔ∏è ‡πÉ‡∏´‡πâ AI ‡∏ó‡∏≤‡∏¢‡∏ß‡πà‡∏≤‡∏õ‡∏±‡πâ‡∏ô‡∏£‡∏π‡∏õ‡∏≠‡∏∞‡πÑ‡∏£!</p>
      </div>
    </div>
  </header>

  <main>
    <div class="card row">
      <section>
        <div class="controls">
          <button id="btnUpload" class="btn" disabled><span class="material-icons">file_upload</span>‡∏£‡∏π‡∏õ‡∏Ç‡∏≠‡∏á‡∏â‡∏±‡∏ô</button>
          <input id="fileInput" type="file" accept="image/*" class="hidden" />
          <button id="btnStartCam" class="btn primary" disabled><span class="material-icons">photo_camera</span>‡πÄ‡∏õ‡∏¥‡∏î‡∏Å‡∏•‡πâ‡∏≠‡∏á‡∏ñ‡πà‡∏≤‡∏¢‡πÄ‡∏•‡∏¢!</button>
          <button id="btnStopCam" class="btn warn hidden"><span class="material-icons">stop</span>‡∏õ‡∏¥‡∏î‡∏Å‡∏•‡πâ‡∏≠‡∏á</button>
        </div>
        <div id="stage" class="previewBox">
          <video id="video" class="hidden" playsinline autoplay muted></video>
          <img id="preview" alt="‡∏ï‡∏±‡∏ß‡∏≠‡∏¢‡πà‡∏≤‡∏á‡∏†‡∏≤‡∏û" class="hidden" />
          <div id="placeholder" class="status">‚òùÔ∏è ‡πÄ‡∏£‡∏¥‡πà‡∏°‡∏ï‡πâ‡∏ô‡∏î‡πâ‡∏ß‡∏¢‡∏Å‡∏≤‡∏£‡∏ñ‡πà‡∏≤‡∏¢‡∏£‡∏π‡∏õ‡∏á‡∏≤‡∏ô‡∏õ‡∏±‡πâ‡∏ô‡∏Å‡∏±‡∏ô‡πÄ‡∏•‡∏¢!</div>
        </div>
        <div style="margin-top:8px" class="status" id="camStatus"></div>
      </section>

      <aside>
        <div class="note" id="modelStatus">‡∏™‡∏ñ‡∏≤‡∏ô‡∏∞‡πÇ‡∏°‡πÄ‡∏î‡∏•: <b>‡∏Å‡∏≥‡∏•‡∏±‡∏á‡πÇ‡∏´‡∏•‡∏î‚Ä¶</b></div>
        <div style="height:12px"></div>
        <div class="result">
          <div class="status">AI ‡∏ó‡∏≤‡∏¢‡∏ß‡πà‡∏≤‚Ä¶</div>
          <h3 id="top1">‚Äî</h3>
          <div id="predList"></div>
        </div>
      </aside>
    </div>

    <div class="result" style="margin-top:25px">
      <h3>üèÜ ‡πÇ‡∏´‡∏°‡∏î‡πÄ‡∏Å‡∏°‡∏õ‡∏±‡πâ‡∏ô! üöÄ</h3>
      
      <div id="challenge"></div> 
      
      <div id="challengeImageContainer" style="margin: 10px 0; text-align: center;">
        <img id="challengeImage" src="" alt="‡∏£‡∏π‡∏õ‡πÇ‡∏à‡∏ó‡∏¢‡πå" class="hidden" style="max-width: 150px; height: auto; border-radius: 10px; border: 3px solid var(--accent);"/>
      </div>
      
      <div id="roundInfo" style="font-weight: bold;">‚Äî</div> <div id="time">‡πÄ‡∏´‡∏•‡∏∑‡∏≠‡πÄ‡∏ß‡∏•‡∏≤: ‚Äî ‡∏ß‡∏¥</div>
      <div id="scoreboard">‡πÑ‡∏î‡πâ‡∏î‡∏≤‡∏ß‡∏™‡∏∞‡∏™‡∏°: <span id="currentScore" style="color: var(--warn);">0</span> ‚≠ê</div> 
      <div id="feedback"></div> 
      
      <div style="display: flex; gap: 10px; margin-top: 15px;">
        <button id="btnStartGame" class="btn good" type="button" disabled>
          <span class="material-icons">sports_esports</span> ‡πÄ‡∏£‡∏¥‡πà‡∏°‡πÄ‡∏Å‡∏°!
        </button>
        <button id="btnStopGameRound" class="btn warn hidden" type="button">
          <span class="material-icons">pause</span> ‡∏´‡∏¢‡∏∏‡∏î‡∏û‡∏±‡∏Å
        </button>
      </div>
    </div>


  </main>

  <footer class="foot">
    <div class="note">üí° **‡πÄ‡∏Ñ‡∏•‡πá‡∏î‡∏•‡∏±‡∏ö** ‡∏ñ‡πà‡∏≤‡∏¢‡∏£‡∏π‡∏õ‡∏ä‡∏±‡∏î ‡πÜ ‡∏°‡∏µ‡πÅ‡∏™‡∏á‡∏™‡∏ß‡πà‡∏≤‡∏á‡∏î‡∏µ ‡πÜ ‡∏â‡∏≤‡∏Å‡∏´‡∏•‡∏±‡∏á‡πÄ‡∏£‡∏µ‡∏¢‡∏ö ‡πÜ ‡∏à‡∏∞‡∏ó‡∏≤‡∏¢‡πÄ‡∏Å‡πà‡∏á‡∏Ç‡∏∂‡πâ‡∏ô‡∏ô‡∏∞!</div>
  </footer>

<script>
  // =====================
  // DOM Elements
  // =====================
  const fileInput = document.getElementById('fileInput');
  const btnUpload = document.getElementById('btnUpload');
  const btnStartCam = document.getElementById('btnStartCam');
  const btnStopCam = document.getElementById('btnStopCam');
  const video = document.getElementById('video');
  const preview = document.getElementById('preview');
  const placeholder = document.getElementById('placeholder');
  const camStatus = document.getElementById('camStatus');
  const modelStatus = document.getElementById('modelStatus');
  const top1 = document.getElementById('top1');
  const predList = document.getElementById('predList');
  const btnStartGame = document.getElementById("btnStartGame");
  const btnStopGameRound = document.getElementById("btnStopGameRound"); // DOM ‡πÉ‡∏´‡∏°‡πà‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö‡∏õ‡∏∏‡πà‡∏°‡∏´‡∏¢‡∏∏‡∏î‡∏û‡∏±‡∏Å
  const challengeText = document.getElementById("challenge");
  const challengeImage = document.getElementById("challengeImage");
  const timeDisplay = document.getElementById("time");
  const scoreDisplay = document.getElementById("currentScore");
  const feedbackDisplay = document.getElementById("feedback");
  const roundInfoDisplay = document.getElementById("roundInfo"); // DOM ‡πÉ‡∏´‡∏°‡πà‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏£‡∏≠‡∏ö


  // =====================
  // ‡πÇ‡∏´‡∏•‡∏î‡πÇ‡∏°‡πÄ‡∏î‡∏•
  // =====================
  const MODEL_URL = "./model/";
  let model, maxPredictions;
  let score = 0;
  
  // ‡∏ü‡∏±‡∏á‡∏Å‡πå‡∏ä‡∏±‡∏ô‡∏õ‡∏•‡∏î‡∏•‡πá‡∏≠‡∏Ñ‡∏õ‡∏∏‡πà‡∏°
  function enableInteraction() {
      btnUpload.disabled = false;
      btnStartCam.disabled = false;
      btnStartGame.disabled = false;
  }

  async function loadModel(){
    try{
      model = await tmImage.load(MODEL_URL+"model.json", MODEL_URL+"metadata.json");
      maxPredictions = model.getTotalClasses();
      modelStatus.innerHTML = '‡∏™‡∏ñ‡∏≤‡∏ô‡∏∞‡πÇ‡∏°‡πÄ‡∏î‡∏•: <b style="color:var(--ok)">‡∏û‡∏£‡πâ‡∏≠‡∏°‡πÉ‡∏ä‡πâ‡∏á‡∏≤‡∏ô</b> ‡∏û‡∏ö‡∏Ñ‡∏•‡∏≤‡∏™: '+maxPredictions;
      
      // ‡∏õ‡∏•‡∏î‡∏•‡πá‡∏≠‡∏Ñ‡πÄ‡∏°‡∏∑‡πà‡∏≠‡πÇ‡∏´‡∏•‡∏î‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à
      enableInteraction(); 
    }catch(err){
      console.error(err);
      modelStatus.classList.add('danger');
      modelStatus.innerHTML = '‡∏™‡∏ñ‡∏≤‡∏ô‡∏∞‡πÇ‡∏°‡πÄ‡∏î‡∏•: <b style="color:var(--err)">‡πÇ‡∏´‡∏•‡∏î‡πÑ‡∏°‡πà‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à</b> <br>‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏≠‡∏ö‡πÑ‡∏ü‡∏•‡πå‡πÉ‡∏ô‡πÇ‡∏ü‡∏•‡πÄ‡∏î‡∏≠‡∏£‡πå **model/** ‡πÅ‡∏•‡∏∞‡∏•‡∏≠‡∏á‡πÇ‡∏´‡∏•‡∏î‡∏´‡∏ô‡πâ‡∏≤‡πÉ‡∏´‡∏°‡πà';
      
      // ‡∏´‡∏≤‡∏Å‡πÇ‡∏´‡∏•‡∏î‡πÑ‡∏°‡πà‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à ‡∏õ‡∏∏‡πà‡∏°‡∏¢‡∏±‡∏á‡∏Ñ‡∏á‡∏ñ‡∏π‡∏Å‡∏•‡πá‡∏≠‡∏Ñ
    }
  }
  loadModel();

  // =====================
  // Class ‚Üí Sound/Image Mapping
  // =====================
  const CLASS_DATA = {
    "‡∏Ñ‡∏ß‡∏≤‡∏¢": { sound: "sounds/buffalo.mp3", image: "challenge_images/buffalo.png" },
    "‡∏£‡∏ñ": { sound: "sounds/car.mp3", image: "challenge_images/car.png" },
    "‡∏ö‡πâ‡∏≤‡∏ô": { sound: "sounds/house.mp3", image: "challenge_images/house.png" },
    "‡πÄ‡∏û‡∏ô‡∏Å‡∏ß‡∏¥‡∏ô": { sound: "sounds/penguin.mp3", image: "challenge_images/penguin.png" },
    "‡∏™‡∏∏‡∏ô‡∏±‡∏Ç": { sound: "sounds/dog.mp3", image: "challenge_images/dog.png" },
    "‡πÑ‡∏Å‡πà": { sound: "sounds/chicken.mp3", image: "challenge_images/chicken.png" },
    "‡∏õ‡∏•‡∏≤": { sound: "sounds/fish.mp3", image: "challenge_images/fish.png" },
    "‡∏´‡∏°‡∏π": { sound: "sounds/pig.mp3", image: "challenge_images/pig.png" }
  };
  let lastSoundTime=0;
  function playSoundForClass(label){
    const now=Date.now();
    if(now-lastSoundTime<3000)return;
    const data = CLASS_DATA[label];
    const file = data ? data.sound : null;
    
    if(file){
      const audio=new Audio(file);
      audio.volume=0.9;
      audio.play().catch(err=>console.warn("‡πÄ‡∏•‡πà‡∏ô‡πÄ‡∏™‡∏µ‡∏¢‡∏á‡πÑ‡∏°‡πà‡πÑ‡∏î‡πâ:",err));
      lastSoundTime=now;
    }
  }

  // =====================
  // DOM / ‡∏Å‡∏•‡πâ‡∏≠‡∏á & ‡∏≠‡∏±‡∏õ‡πÇ‡∏´‡∏•‡∏î
  // =====================
  btnUpload.addEventListener('click',()=>fileInput.click());
  fileInput.addEventListener('change',async e=>{
    const file=e.target.files&&e.target.files[0];
    if(!file)return;
    stopCamera();
    const url=URL.createObjectURL(file);
    preview.src=url;
    await showImage();
    await predict(preview);
  });

  let stream,running=false;
  const TARGET_FPS=2;
  const FRAME_INTERVAL=1000/TARGET_FPS;
  let lastTime=0;

  async function startCamera(){
    if (!model) { // ‡∏õ‡πâ‡∏≠‡∏á‡∏Å‡∏±‡∏ô‡∏Å‡∏≤‡∏£‡πÄ‡∏£‡∏µ‡∏¢‡∏Å‡πÉ‡∏ä‡πâ‡∏Å‡∏•‡πâ‡∏≠‡∏á‡∏ñ‡πâ‡∏≤‡πÇ‡∏°‡πÄ‡∏î‡∏•‡∏¢‡∏±‡∏á‡πÑ‡∏°‡πà‡∏û‡∏£‡πâ‡∏≠‡∏°
        camStatus.textContent = "‚ùå ‡πÇ‡∏°‡πÄ‡∏î‡∏•‡∏¢‡∏±‡∏á‡πÑ‡∏°‡πà‡∏û‡∏£‡πâ‡∏≠‡∏°‡∏ó‡∏≥‡∏á‡∏≤‡∏ô";
        return;
    }
    try{
      stream=await navigator.mediaDevices.getUserMedia({
        video:{width:{ideal:640},height:{ideal:480},facingMode:"environment"},
        audio:false
      });
      video.srcObject=stream;
      await new Promise(res=>video.onloadedmetadata=res);
      video.play();
      video.classList.remove('hidden');
      preview.classList.add('hidden');
      placeholder.classList.add('hidden');
      btnStopCam.classList.remove('hidden');
      camStatus.textContent='‡πÇ‡∏´‡∏°‡∏î‡πÄ‡∏£‡∏µ‡∏¢‡∏•‡πÑ‡∏ó‡∏°‡πå: ‡∏Å‡∏•‡πâ‡∏≠‡∏á‡∏Å‡∏≥‡∏•‡∏±‡∏á‡∏ó‡∏≥‡∏á‡∏≤‡∏ô‚Ä¶';
      running=true;
      requestAnimationFrame(predictLoop);
    }catch(err){camStatus.textContent='‡πÑ‡∏°‡πà‡∏™‡∏≤‡∏°‡∏≤‡∏£‡∏ñ‡πÄ‡∏õ‡∏¥‡∏î‡∏Å‡∏•‡πâ‡∏≠‡∏á‡πÑ‡∏î‡πâ: '+err.message;}
  }
  function stopCamera(){
    running=false;
    if(stream){stream.getTracks().forEach(t=>t.stop());stream=null;}
    video.classList.add('hidden');
    btnStopCam.classList.add('hidden');
    camStatus.textContent='';
  }
  btnStartCam.addEventListener('click',startCamera);
  btnStopCam.addEventListener('click',stopCamera);

  async function predictLoop(now){
    if(!running)return;
    if(now-lastTime>=FRAME_INTERVAL){
      lastTime=now;
      if(model&&video.readyState>=2){
        try{const preds=await model.predict(video,false);renderPredictions(preds);}catch(e){console.error(e);}
      }
    }
    requestAnimationFrame(predictLoop);
  }

  async function showImage(){
    video.classList.add('hidden');
    preview.classList.remove('hidden');
    placeholder.classList.add('hidden');
    await new Promise(r=>(preview.onload=r));
  }
  async function predict(imgEl){
    if(!model){top1.textContent='‡πÇ‡∏°‡πÄ‡∏î‡∏•‡∏¢‡∏±‡∏á‡πÑ‡∏°‡πà‡∏û‡∏£‡πâ‡∏≠‡∏°';return;}
    const predictions=await model.predict(imgEl,false);
    renderPredictions(predictions);
  }

  function renderPredictions(predictions){
    predictions.sort((a,b)=>b.probability-a.probability);
    const best=predictions[0];
    const pct=(best.probability*100).toFixed(1);
    top1.textContent=`AI ‡∏ó‡∏≤‡∏¢‡∏ß‡πà‡∏≤: üíñ ${best.className} üíñ (‡∏°‡∏±‡πà‡∏ô‡πÉ‡∏à ${pct}%)`;

    if(predList.childElementCount!==predictions.length){
      predList.innerHTML='';
      for(let i=0;i<predictions.length;i++){
        const row=document.createElement('div');
        row.className='pred';
        row.innerHTML=`<div class="name"></div><div class="bar"><span></span></div><div class="val"></div>`;
        predList.appendChild(row);
      }
    }
    [...predList.children].forEach((row,i)=>{
      const p=predictions[i];
      const percent=(p.probability*100).toFixed(1);
      row.querySelector('.name').textContent=p.className;
      row.querySelector('.bar > span').style.width=percent+'%';
      row.querySelector('.val').textContent=percent+'%';
    });

    if(best.probability>=0.6){
      playSoundForClass(best.className);
      // ‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏≠‡∏ö‡∏ú‡∏•‡∏•‡∏±‡∏û‡∏ò‡πå‡πÄ‡∏Å‡∏°‡πÄ‡∏â‡∏û‡∏≤‡∏∞‡πÄ‡∏°‡∏∑‡πà‡∏≠‡πÇ‡∏°‡πÄ‡∏î‡∏•‡∏ó‡∏≥‡∏ô‡∏≤‡∏¢‡πÑ‡∏î‡πâ‡∏î‡πâ‡∏ß‡∏¢‡∏Ñ‡∏ß‡∏≤‡∏°‡∏°‡∏±‡πà‡∏ô‡πÉ‡∏à‡∏™‡∏π‡∏á
      checkPrediction(best.className); 
    }
  }

  // =====================
  // üéÆ ‡πÇ‡∏´‡∏°‡∏î‡πÄ‡∏Å‡∏°‡∏õ‡∏±‡πâ‡∏ô‡∏Ñ‡∏ô‡πÄ‡∏î‡∏µ‡∏¢‡∏ß (‡∏≠‡∏±‡∏õ‡πÄ‡∏î‡∏ï: 5 ‡∏£‡∏≠‡∏ö, 3 ‡∏ô‡∏≤‡∏ó‡∏µ, ‡∏î‡∏≤‡∏ß)
  // =====================
  let currentScore = 0;¬† ¬† ¬† // ‡∏î‡∏≤‡∏ß‡∏™‡∏∞‡∏™‡∏°
  let currentRound = 0;¬† ¬† ¬† // ‡∏£‡∏≠‡∏ö‡∏õ‡∏±‡∏à‡∏à‡∏∏‡∏ö‡∏±‡∏ô
  const MAX_ROUNDS = 5;¬† ¬† ¬† // ‡∏™‡∏π‡∏á‡∏™‡∏∏‡∏î 5 ‡∏£‡∏≠‡∏ö
  const ROUND_TIME_SECONDS = 180; // 3 ‡∏ô‡∏≤‡∏ó‡∏µ = 180 ‡∏ß‡∏¥‡∏ô‡∏≤‡∏ó‡∏µ
  let currentChallenge = "";
  let roundTime = ROUND_TIME_SECONDS;
  let timerInterval;

  btnStartGame.addEventListener("click", startGame);
  btnStopGameRound.addEventListener("click", stopGame); 

  // ‡∏ü‡∏±‡∏á‡∏Å‡πå‡∏ä‡∏±‡∏ô‡πÄ‡∏£‡∏¥‡πà‡∏°‡πÄ‡∏Å‡∏° (‡πÄ‡∏£‡∏¥‡πà‡∏°‡πÄ‡∏ã‡πá‡∏ï‡∏Ñ‡∏∞‡πÅ‡∏ô‡∏ô‡πÅ‡∏•‡∏∞‡∏£‡∏≠‡∏ö‡πÅ‡∏£‡∏Å)
  function startGame(){
    if(!model){
      feedbackDisplay.textContent = "‚ùå ‡πÇ‡∏°‡πÄ‡∏î‡∏• AI ‡∏¢‡∏±‡∏á‡πÇ‡∏´‡∏•‡∏î‡πÑ‡∏°‡πà‡πÄ‡∏™‡∏£‡πá‡∏à ‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡∏£‡∏≠‡∏™‡∏±‡∏Å‡∏Ñ‡∏£‡∏π‡πà!";
      return;
    }
    currentScore = 0;
    currentRound = 0; // ‡πÄ‡∏£‡∏¥‡πà‡∏°‡∏£‡∏≠‡∏ö‡∏ó‡∏µ‡πà 0
    scoreDisplay.textContent = currentScore;
    btnStartGame.disabled = true;
    btnStopGameRound.classList.remove('hidden'); // ‡πÅ‡∏™‡∏î‡∏á‡∏õ‡∏∏‡πà‡∏°‡∏´‡∏¢‡∏∏‡∏î‡πÄ‡∏Å‡∏°
    startNewRound();
  }

  // ‡∏ü‡∏±‡∏á‡∏Å‡πå‡∏ä‡∏±‡∏ô‡∏´‡∏¢‡∏∏‡∏î‡πÄ‡∏Å‡∏° (‡∏ä‡∏±‡πà‡∏ß‡∏Ñ‡∏£‡∏≤‡∏ß/‡∏û‡∏±‡∏Å)
  function stopGame(){
    clearInterval(timerInterval);
    feedbackDisplay.textContent = "‚è∏Ô∏è ‡∏´‡∏¢‡∏∏‡∏î‡∏û‡∏±‡∏Å‡πÅ‡∏•‡πâ‡∏ß‡∏ô‡∏∞! ‡∏ñ‡πâ‡∏≤‡∏û‡∏£‡πâ‡∏≠‡∏°‡πÅ‡∏•‡πâ‡∏ß‡∏Å‡∏î '‡πÄ‡∏£‡∏¥‡πà‡∏°‡πÄ‡∏Å‡∏°!' ‡πÄ‡∏û‡∏∑‡πà‡∏≠‡πÄ‡∏•‡πà‡∏ô‡∏ï‡πà‡∏≠";
    feedbackDisplay.style.color = 'var(--warn)';
    
    // ‡πÄ‡∏õ‡∏•‡∏µ‡πà‡∏¢‡∏ô‡∏õ‡∏∏‡πà‡∏°‡∏´‡∏¢‡∏∏‡∏î‡∏û‡∏±‡∏Å‡πÄ‡∏õ‡πá‡∏ô‡∏õ‡∏∏‡πà‡∏°‡πÄ‡∏£‡∏¥‡πà‡∏°‡πÄ‡∏Å‡∏°
    btnStopGameRound.classList.add('hidden');
    btnStartGame.disabled = false;
  }

  // ‡∏ü‡∏±‡∏á‡∏Å‡πå‡∏ä‡∏±‡∏ô‡∏à‡∏ö‡πÄ‡∏Å‡∏°
  function endGame(){
    clearInterval(timerInterval);
    challengeText.innerHTML = `<h3>‡πÄ‡∏Å‡∏°‡∏à‡∏ö‡πÅ‡∏•‡πâ‡∏ß! ‡πÄ‡∏Å‡πà‡∏á‡∏°‡∏≤‡∏Å! üéâ</h3>`;
    roundInfoDisplay.textContent = `‡πÑ‡∏î‡πâ‡∏î‡∏≤‡∏ß‡∏™‡∏∞‡∏™‡∏°‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î: ${currentScore} ‚≠ê`;
    timeDisplay.textContent = ``;
    feedbackDisplay.textContent = `‡∏õ‡∏±‡πâ‡∏ô‡∏Ñ‡∏£‡∏ö ${MAX_ROUNDS} ‡∏£‡∏≠‡∏ö‡πÅ‡∏•‡πâ‡∏ß! ‡πÑ‡∏î‡πâ ${currentScore} ‡∏î‡∏≤‡∏ß!`;
    feedbackDisplay.style.color = 'var(--accent)';

    challengeImage.classList.add('hidden');
    btnStopGameRound.classList.add('hidden');
    btnStartGame.disabled = false; // ‡πÉ‡∏´‡πâ‡πÄ‡∏£‡∏¥‡πà‡∏°‡πÄ‡∏Å‡∏°‡πÉ‡∏´‡∏°‡πà‡πÑ‡∏î‡πâ
  }


  // ‡∏ü‡∏±‡∏á‡∏Å‡πå‡∏ä‡∏±‡∏ô‡πÄ‡∏£‡∏¥‡πà‡∏°‡∏£‡∏≠‡∏ö‡πÉ‡∏´‡∏°‡πà
  function startNewRound(){
    currentRound++;
    if (currentRound > MAX_ROUNDS) {
      endGame();
      return;
    }

    // ‡∏£‡∏µ‡πÄ‡∏ã‡πá‡∏ï‡∏™‡∏ñ‡∏≤‡∏ô‡∏∞
    roundInfoDisplay.textContent = `‚≠ê ‡∏£‡∏≠‡∏ö‡∏ó‡∏µ‡πà ${currentRound} ‡∏à‡∏≤‡∏Å ${MAX_ROUNDS} ‡∏£‡∏≠‡∏ö`;
    
    // 1. ‡∏™‡∏∏‡πà‡∏°‡πÇ‡∏à‡∏ó‡∏¢‡πå
    const classes = Object.keys(CLASS_DATA);
    currentChallenge = classes[Math.floor(Math.random()*classes.length)];
    const challengeImgPath = CLASS_DATA[currentChallenge].image;

    // 2. ‡πÅ‡∏™‡∏î‡∏á‡πÇ‡∏à‡∏ó‡∏¢‡πå
    challengeText.innerHTML = `<h3>‡∏õ‡∏±‡πâ‡∏ô‡∏™‡∏¥‡πà‡∏á‡∏ô‡∏µ‡πâ‡πÉ‡∏´‡πâ AI ‡∏ó‡∏≤‡∏¢‡∏ñ‡∏π‡∏Å: üé® ${currentChallenge}</h3>`;
    challengeImage.src = challengeImgPath;
    challengeImage.classList.remove('hidden');
    feedbackDisplay.textContent = '‡∏õ‡∏±‡πâ‡∏ô‡πÄ‡∏•‡∏¢! ‡∏™‡∏π‡πâ‡πÜ!';
    feedbackDisplay.style.color = 'var(--fg)';

    // 3. ‡πÄ‡∏£‡∏¥‡πà‡∏°‡∏à‡∏±‡∏ö‡πÄ‡∏ß‡∏•‡∏≤
    roundTime = ROUND_TIME_SECONDS;
    clearInterval(timerInterval);
    timerInterval = setInterval(()=>{
      roundTime--;
      
      const minutes = Math.floor(roundTime / 60);
      const seconds = roundTime % 60;
      const timeStr = `${minutes}:${seconds.toString().padStart(2, '0')}`;
      
      timeDisplay.textContent = "‡πÄ‡∏´‡∏•‡∏∑‡∏≠‡πÄ‡∏ß‡∏•‡∏≤: " + timeStr;
      
      // ‡∏™‡∏µ‡πÅ‡∏î‡∏á‡πÄ‡∏°‡∏∑‡πà‡∏≠‡πÉ‡∏Å‡∏•‡πâ‡∏´‡∏°‡∏î‡πÄ‡∏ß‡∏•‡∏≤ (20 ‡∏ß‡∏¥‡∏ô‡∏≤‡∏ó‡∏µ‡∏™‡∏∏‡∏î‡∏ó‡πâ‡∏≤‡∏¢)
      if (roundTime <= 20) {
          timeDisplay.style.color = 'var(--err)'; 
      } else {
          timeDisplay.style.color = 'var(--fg)';
      }

      if(roundTime <= 0){
        clearInterval(timerInterval);
        feedbackDisplay.textContent = `‚ùå ‡∏´‡∏°‡∏î‡πÄ‡∏ß‡∏•‡∏≤! ‡∏õ‡∏±‡πâ‡∏ô ${currentChallenge} ‡πÑ‡∏°‡πà‡∏ó‡∏±‡∏ô!`;
        feedbackDisplay.style.color = 'var(--err)';
        setTimeout(startNewRound, 3000); // ‡∏£‡∏≠ 3 ‡∏ß‡∏¥‡πÅ‡∏•‡πâ‡∏ß‡πÄ‡∏£‡∏¥‡πà‡∏°‡∏£‡∏≠‡∏ö‡πÉ‡∏´‡∏°‡πà
      }
    },1000);
  }

  // ‡∏ü‡∏±‡∏á‡∏Å‡πå‡∏ä‡∏±‡∏ô‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏≠‡∏ö‡∏ú‡∏•‡∏•‡∏±‡∏û‡∏ò‡πå
  function checkPrediction(label){
    // ‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏≠‡∏ö‡πÄ‡∏â‡∏û‡∏≤‡∏∞‡∏ñ‡πâ‡∏≤‡πÄ‡∏Å‡∏°‡∏Å‡∏≥‡∏•‡∏±‡∏á‡πÄ‡∏•‡πà‡∏ô‡∏≠‡∏¢‡∏π‡πà ‡πÅ‡∏•‡∏∞‡∏¢‡∏±‡∏á‡πÑ‡∏°‡πà‡∏´‡∏°‡∏î‡πÄ‡∏ß‡∏•‡∏≤
    if(label === currentChallenge && roundTime > 0){
      currentScore++;
      scoreDisplay.textContent = currentScore;
      
      clearInterval(timerInterval);
      feedbackDisplay.textContent = `‚úÖ ‡πÑ‡∏î‡πâ‡∏î‡∏≤‡∏ß‡πÅ‡∏•‡πâ‡∏ß! ‡∏õ‡∏±‡πâ‡∏ô ${currentChallenge} ‡∏ñ‡∏π‡∏Å‡∏ï‡πâ‡∏≠‡∏á!`;
      feedbackDisplay.style.color = 'var(--ok)'; 
      
      // ‡πÉ‡∏´‡πâ‡∏õ‡∏∏‡πà‡∏°‡πÄ‡∏£‡∏¥‡πà‡∏°‡πÄ‡∏Å‡∏°‡∏õ‡∏£‡∏≤‡∏Å‡∏è‡∏Ç‡∏∂‡πâ‡∏ô‡∏≠‡∏µ‡∏Å‡∏Ñ‡∏£‡∏±‡πâ‡∏á‡πÄ‡∏û‡∏∑‡πà‡∏≠‡πÉ‡∏´‡πâ‡∏ú‡∏π‡πâ‡πÉ‡∏ä‡πâ‡∏Å‡∏î‡πÄ‡∏£‡∏¥‡πà‡∏°‡∏£‡∏≠‡∏ö‡πÉ‡∏´‡∏°‡πà‡πÑ‡∏î‡πâ ‡∏´‡∏£‡∏∑‡∏≠‡πÉ‡∏´‡πâ‡πÄ‡∏£‡∏¥‡πà‡∏°‡∏≠‡∏±‡∏ï‡πÇ‡∏ô‡∏°‡∏±‡∏ï‡∏¥
      setTimeout(startNewRound, 3000); // ‡πÄ‡∏£‡∏¥‡πà‡∏°‡∏£‡∏≠‡∏ö‡∏ñ‡∏±‡∏î‡πÑ‡∏õ
    } else if (roundTime > 0 && label !== currentChallenge) {
      feedbackDisplay.textContent = `ü§î AI ‡∏ó‡∏≤‡∏¢‡∏ß‡πà‡∏≤ ${label}... ‡∏•‡∏≠‡∏á‡∏õ‡∏±‡πâ‡∏ô ${currentChallenge} ‡πÉ‡∏´‡πâ‡∏ä‡∏±‡∏î‡∏Å‡∏ß‡πà‡∏≤‡∏ô‡∏µ‡πâ‡∏´‡∏ô‡πà‡∏≠‡∏¢‡∏™‡∏¥!`;
      feedbackDisplay.style.color = 'var(--warn)';
    }
  }
</script>
</body>
</html>
