<!DOCTYPE html>
<html lang="th">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Clay Shape Recognition</title>
  <meta name="description" content="‡∏™‡πÅ‡∏Å‡∏ô‡∏á‡∏≤‡∏ô‡∏õ‡∏±‡πâ‡∏ô‡∏î‡∏¥‡∏ô‡∏ô‡πâ‡∏≥‡∏°‡∏±‡∏ô‡∏î‡πâ‡∏ß‡∏¢‡∏Å‡∏•‡πâ‡∏≠‡∏á‡∏´‡∏£‡∏∑‡∏≠‡∏≠‡∏±‡∏õ‡πÇ‡∏´‡∏•‡∏î‡∏£‡∏π‡∏õ ‡πÅ‡∏•‡πâ‡∏ß‡πÉ‡∏´‡πâ AI (Teachable Machine) ‡∏ó‡∏≤‡∏¢‡∏ß‡πà‡∏≤‡πÄ‡∏õ‡πá‡∏ô‡∏£‡∏π‡∏õ‡∏≠‡∏∞‡πÑ‡∏£" />
  <script src="https://cdn.jsdelivr.net/npm/@tensorflow/tfjs@4.16.0/dist/tf.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/@teachablemachine/image@0.8/dist/teachablemachine-image.min.js"></script>
  <link href="https://fonts.googleapis.com/icon?family=Material+Icons" rel="stylesheet">
  <link rel="icon" type="image/png" href="CSR.png">

  <style>
  :root {
    --bg-gradient: linear-gradient(135deg, #a5f3fc, #fbcfe8, #fde68a);
    --fg: #1f2937;
    --muted: #6b7280;
    --card: rgba(255,255,255,0.85);
    --accent: #ec4899;
    --ok: #34d399;
    --warn: #f97316;
    --err: #ef4444;
    --ring: #e5e7eb;
  }

  body {
    margin: 0;
    font-family: ui-sans-serif, system-ui, -apple-system, Segoe UI, Roboto, Helvetica, Arial;
    background: var(--bg-gradient);
    background-attachment: fixed;
    color: var(--fg);
  }

  header { max-width: 960px; margin: 24px auto 0; padding: 0 16px; }
  .title.center { display: flex; flex-direction: column; align-items: center; text-align: center; }
  .logo { width: 100px; height: 100px; border-radius: 16px; overflow: hidden; display: flex; align-items: center; justify-content: center; margin-bottom: 10px; }
  .logo img { max-width: 100%; max-height: 100%; object-fit: contain; }
  h1 { font-size: clamp(20px, 4vw, 30px); margin: 0; }
  p.sub { color: var(--muted); margin: 6px 0 0; }

  main { max-width: 960px; margin: 20px auto 56px; padding: 0 16px; }
  .card { background: var(--card); border: 1px solid var(--ring); border-radius: 18px; padding: 20px; box-shadow: 0 8px 24px rgba(0,0,0,.1); backdrop-filter: blur(10px); margin-bottom: 20px; }
  .row { display: grid; gap: 16px; }
  @media (min-width: 900px) { .row { grid-template-columns: 1.2fr .8fr; } }

  .controls { display: flex; flex-wrap: wrap; gap: 10px; margin: 8px 0 12px; }
  .btn { appearance: none; border: none; background: #fff; color: var(--fg); padding: 10px 16px; border-radius: 14px; cursor: pointer; transition: .2s; box-shadow: 0 3px 8px rgba(0,0,0,.08); }
  .btn:hover { transform: translateY(-2px) scale(1.02); }
  .btn.primary { background: var(--accent); color: #fff; }
  .btn.good { background: var(--ok); color: #fff; }
  .btn.warn { background: var(--warn); color: #fff; }
  .hidden { display: none!important; }

  .previewBox { background: rgba(255,255,255,0.9); border: 2px dashed var(--ring); border-radius: 16px; min-height: 320px; display: grid; place-items: center; overflow: hidden; }
  video, img { max-width: 100%; height: auto; display: block; }

  .status { font-size: 14px; color: var(--muted); }
  .result { background: rgba(255,255,255,0.9); border: 1px solid var(--ring); border-radius: 14px; padding: 14px; box-shadow: 0 3px 10px rgba(0,0,0,.05); }
  .pred { display: flex; align-items: center; justify-content: space-between; gap: 10px; margin: 8px 0; }
  .bar { height: 10px; background: #f3f4f6; border-radius: 999px; overflow: hidden; flex: 1; margin: 0 10px; }
  .bar > span { display: block; height: 100%; background: var(--accent); width: 0%; }

  .foot { max-width: 960px; margin: 10px auto 32px; padding: 0 16px; color: var(--muted); font-size: 13px; text-align: center; }
  .note { padding: 10px 12px; border-left: 4px solid var(--accent); background: #fdf2f8; border-radius: 8px; }
  .danger { border-left-color: var(--err); background: #fef2f2; }
  .ok { border-left-color: var(--ok); background: #ecfdf5; }
  </style>
</head>
<body>
  <header>
    <div class="title center">
      <div class="logo"><img src="CSR.png" alt="CSR Logo"></div>
      <div>
        <h1>Clay Shape Recognition ‚Äî AI ‡∏ó‡∏≤‡∏¢‡∏á‡∏≤‡∏ô‡∏õ‡∏±‡πâ‡∏ô‡∏î‡∏¥‡∏ô‡∏ô‡πâ‡∏≥‡∏°‡∏±‡∏ô</h1>
        <p class="sub">‡∏≠‡∏±‡∏õ‡πÇ‡∏´‡∏•‡∏î‡∏†‡∏≤‡∏û‡∏´‡∏£‡∏∑‡∏≠‡πÄ‡∏õ‡∏¥‡∏î‡∏Å‡∏•‡πâ‡∏≠‡∏á ‡πÅ‡∏•‡πâ‡∏ß‡πÉ‡∏´‡πâ‡πÇ‡∏°‡πÄ‡∏î‡∏• <b>Teachable Machine</b> ‡∏ó‡∏≥‡∏ô‡∏≤‡∏¢‡∏ß‡πà‡∏≤‡πÄ‡∏õ‡πá‡∏ô‡∏£‡∏π‡∏õ‡∏≠‡∏∞‡πÑ‡∏£</p>
      </div>
    </div>
  </header>

  <main>
    <!-- ‡∏Å‡∏•‡πâ‡∏≠‡∏á‡πÅ‡∏•‡∏∞‡∏ú‡∏•‡∏ó‡∏≥‡∏ô‡∏≤‡∏¢ -->
    <div class="card row">
      <section>
        <div class="controls">
          <button id="btnUpload" class="btn"><span class="material-icons">file_upload</span>‡∏≠‡∏±‡∏õ‡πÇ‡∏´‡∏•‡∏î‡∏£‡∏π‡∏õ</button>
          <input id="fileInput" type="file" accept="image/*" class="hidden" />
          <button id="btnStartCam" class="btn primary"><span class="material-icons">photo_camera</span>‡πÄ‡∏õ‡∏¥‡∏î‡∏Å‡∏•‡πâ‡∏≠‡∏á</button>
          <button id="btnStopCam" class="btn warn hidden"><span class="material-icons">stop</span>‡∏õ‡∏¥‡∏î‡∏Å‡∏•‡πâ‡∏≠‡∏á</button>
        </div>
        <div id="stage" class="previewBox">
          <video id="video" class="hidden" playsinline autoplay muted></video>
          <img id="preview" alt="‡∏ï‡∏±‡∏ß‡∏≠‡∏¢‡πà‡∏≤‡∏á‡∏†‡∏≤‡∏û" class="hidden" />
          <div id="placeholder" class="status">‡∏¢‡∏±‡∏á‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏†‡∏≤‡∏û ‚Äî ‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏≠‡∏±‡∏õ‡πÇ‡∏´‡∏•‡∏î‡∏´‡∏£‡∏∑‡∏≠‡πÄ‡∏õ‡∏¥‡∏î‡∏Å‡∏•‡πâ‡∏≠‡∏á‡πÄ‡∏û‡∏∑‡πà‡∏≠‡πÄ‡∏£‡∏¥‡πà‡∏°‡∏ï‡πâ‡∏ô</div>
        </div>
        <div style="margin-top:8px" class="status" id="camStatus"></div>
      </section>

      <aside>
        <div class="note" id="modelStatus">‡∏™‡∏ñ‡∏≤‡∏ô‡∏∞‡πÇ‡∏°‡πÄ‡∏î‡∏•: <b>‡∏Å‡∏≥‡∏•‡∏±‡∏á‡πÇ‡∏´‡∏•‡∏î‚Ä¶</b></div>
        <div style="height:12px"></div>
        <div class="result">
          <div class="status">‡∏ú‡∏•‡∏Å‡∏≤‡∏£‡∏ó‡∏≥‡∏ô‡∏≤‡∏¢</div>
          <h3 id="top1">‚Äî</h3>
          <div id="predList"></div>
        </div>
      </aside>
    </div>

    <!-- üèÜ ‡πÇ‡∏´‡∏°‡∏î‡πÅ‡∏Ç‡πà‡∏á‡∏Ç‡∏±‡∏ô -->
   <div class="result">
  <div class="status">‡∏ú‡∏•‡∏Å‡∏≤‡∏£‡∏ó‡∏≥‡∏ô‡∏≤‡∏¢</div>
  <h3 id="top1" style="margin:8px 0 4px">‚Äî</h3>
  <div id="predList"></div>
</div>

<!-- üéÆ ‡∏™‡πà‡∏ß‡∏ô‡∏Å‡∏≤‡∏£‡πÅ‡∏Ç‡πà‡∏á‡∏Ç‡∏±‡∏ô -->
<div class="result" style="margin-top:16px">
  <h3>‡πÇ‡∏´‡∏°‡∏î‡πÅ‡∏Ç‡πà‡∏á‡∏Ç‡∏±‡∏ô</h3>
  <div id="challenge">‚Äî</div>
  <div id="time">‡πÄ‡∏´‡∏•‡∏∑‡∏≠‡πÄ‡∏ß‡∏•‡∏≤: ‚Äî ‡∏ß‡∏¥</div>
  <div id="leaderboard"></div>
  <button id="btnStartGame" class="btn good" type="button">
    <span class="material-icons">sports_esports</span> ‡πÄ‡∏£‡∏¥‡πà‡∏°‡πÅ‡∏Ç‡πà‡∏á
  </button>
</div>

  </main>

  <footer class="foot">
    <div class="note">üí° ‡πÄ‡∏Ñ‡∏•‡πá‡∏î‡∏•‡∏±‡∏ö‡∏Ñ‡∏ß‡∏≤‡∏°‡πÅ‡∏°‡πà‡∏ô‡∏¢‡∏≥: ‡∏à‡∏±‡∏î‡πÑ‡∏ü‡πÉ‡∏´‡πâ‡∏™‡∏°‡πà‡∏≥‡πÄ‡∏™‡∏°‡∏≠ ‡∏â‡∏≤‡∏Å‡∏´‡∏•‡∏±‡∏á‡πÄ‡∏£‡∏µ‡∏¢‡∏ö ‡πÅ‡∏•‡∏∞‡∏ñ‡πà‡∏≤‡∏¢‡∏´‡∏•‡∏≤‡∏¢‡∏°‡∏∏‡∏°</div>
  </footer>

<script>
  // =====================
  // ‡πÇ‡∏´‡∏•‡∏î‡πÇ‡∏°‡πÄ‡∏î‡∏•
  // =====================
  const MODEL_URL = "./model/";
  let model, maxPredictions;
  const modelStatus = document.getElementById('modelStatus');
  const top1 = document.getElementById('top1');
  const predList = document.getElementById('predList');

  async function loadModel(){
    try{
      model = await tmImage.load(MODEL_URL+"model.json", MODEL_URL+"metadata.json");
      maxPredictions = model.getTotalClasses();
      modelStatus.innerHTML = '‡∏™‡∏ñ‡∏≤‡∏ô‡∏∞‡πÇ‡∏°‡πÄ‡∏î‡∏•: <b style="color:var(--ok)">‡∏û‡∏£‡πâ‡∏≠‡∏°‡πÉ‡∏ä‡πâ‡∏á‡∏≤‡∏ô</b> ‡∏û‡∏ö‡∏Ñ‡∏•‡∏≤‡∏™: '+maxPredictions;
    }catch(err){
      console.error(err);
      modelStatus.classList.add('danger');
      modelStatus.innerHTML = '‡∏™‡∏ñ‡∏≤‡∏ô‡∏∞‡πÇ‡∏°‡πÄ‡∏î‡∏•: <b style="color:var(--err)">‡πÇ‡∏´‡∏•‡∏î‡πÑ‡∏°‡πà‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à</b>';
    }
  }
  loadModel();

  // =====================
  // Class ‚Üí Sound Mapping
  // =====================
  const CLASS_SOUNDS = {
    "‡∏Ñ‡∏ß‡∏≤‡∏¢": "sounds/buffalo.mp3",
    "‡∏£‡∏ñ": "sounds/car.mp3",
    "‡∏ö‡πâ‡∏≤‡∏ô": "sounds/house.mp3",
    "‡πÄ‡∏û‡∏ô‡∏Å‡∏ß‡∏¥‡∏ô": "sounds/penguin.mp3",
    "‡∏™‡∏∏‡∏ô‡∏±‡∏Ç": "sounds/dog.mp3",
    "‡πÑ‡∏Å‡πà": "sounds/chicken.mp3",
    "‡∏õ‡∏•‡∏≤": "sounds/fish.mp3",
    "‡∏´‡∏°‡∏π": "sounds/pig.mp3"
  };
  let lastSoundTime=0;
  function playSoundForClass(label){
    const now=Date.now();
    if(now-lastSoundTime<3000)return;
    const file=CLASS_SOUNDS[label];
    if(file){
      const audio=new Audio(file);
      audio.volume=0.9;
      audio.play().catch(err=>console.warn("‡πÄ‡∏•‡πà‡∏ô‡πÄ‡∏™‡∏µ‡∏¢‡∏á‡πÑ‡∏°‡πà‡πÑ‡∏î‡πâ:",err));
      lastSoundTime=now;
    }
  }

  // =====================
  // DOM / ‡∏Å‡∏•‡πâ‡∏≠‡∏á
  // =====================
  const fileInput=document.getElementById('fileInput');
  const btnUpload=document.getElementById('btnUpload');
  const btnStartCam=document.getElementById('btnStartCam');
  const btnStopCam=document.getElementById('btnStopCam');
  const video=document.getElementById('video');
  const preview=document.getElementById('preview');
  const placeholder=document.getElementById('placeholder');
  const camStatus=document.getElementById('camStatus');

  btnUpload.addEventListener('click',()=>fileInput.click());
  fileInput.addEventListener('change',async e=>{
    const file=e.target.files&&e.target.files[0];
    if(!file)return;
    stopCamera();
    const url=URL.createObjectURL(file);
    preview.src=url;
    await showImage();
    await predict(preview);
  });

  let stream,running=false;
  const TARGET_FPS=2;
  const FRAME_INTERVAL=1000/TARGET_FPS;
  let lastTime=0;

  async function startCamera(){
    try{
      stream=await navigator.mediaDevices.getUserMedia({
        video:{width:{ideal:640},height:{ideal:480},facingMode:"environment"},
        audio:false
      });
      video.srcObject=stream;
      await new Promise(res=>video.onloadedmetadata=res);
      video.play();
      video.classList.remove('hidden');
      preview.classList.add('hidden');
      placeholder.classList.add('hidden');
      btnStopCam.classList.remove('hidden');
      camStatus.textContent='‡πÇ‡∏´‡∏°‡∏î‡πÄ‡∏£‡∏µ‡∏¢‡∏•‡πÑ‡∏ó‡∏°‡πå: ‡∏Å‡∏•‡πâ‡∏≠‡∏á‡∏Å‡∏≥‡∏•‡∏±‡∏á‡∏ó‡∏≥‡∏á‡∏≤‡∏ô‚Ä¶';
      running=true;
      requestAnimationFrame(predictLoop);
    }catch(err){camStatus.textContent='‡πÑ‡∏°‡πà‡∏™‡∏≤‡∏°‡∏≤‡∏£‡∏ñ‡πÄ‡∏õ‡∏¥‡∏î‡∏Å‡∏•‡πâ‡∏≠‡∏á‡πÑ‡∏î‡πâ: '+err.message;}
  }
  function stopCamera(){
    running=false;
    if(stream){stream.getTracks().forEach(t=>t.stop());stream=null;}
    video.classList.add('hidden');
    btnStopCam.classList.add('hidden');
    camStatus.textContent='';
  }
  btnStartCam.addEventListener('click',startCamera);
  btnStopCam.addEventListener('click',stopCamera);

  async function predictLoop(now){
    if(!running)return;
    if(now-lastTime>=FRAME_INTERVAL){
      lastTime=now;
      if(model&&video.readyState>=2){
        try{const preds=await model.predict(video,false);renderPredictions(preds);}catch(e){console.error(e);}
      }
    }
    requestAnimationFrame(predictLoop);
  }

  async function showImage(){
    video.classList.add('hidden');
    preview.classList.remove('hidden');
    placeholder.classList.add('hidden');
    await new Promise(r=>(preview.onload=r));
  }
  async function predict(imgEl){
    if(!model){top1.textContent='‡πÇ‡∏°‡πÄ‡∏î‡∏•‡∏¢‡∏±‡∏á‡πÑ‡∏°‡πà‡∏û‡∏£‡πâ‡∏≠‡∏°';return;}
    const predictions=await model.predict(imgEl,false);
    renderPredictions(predictions);
  }

  function renderPredictions(predictions){
    predictions.sort((a,b)=>b.probability-a.probability);
    const best=predictions[0];
    const pct=(best.probability*100).toFixed(1);
    top1.textContent=`‡∏™‡∏¥‡πà‡∏á‡∏ó‡∏µ‡πà‡∏õ‡∏±‡πâ‡∏ô‡∏Ñ‡∏∑‡∏≠: ${best.className} (‡∏Ñ‡∏ß‡∏≤‡∏°‡∏°‡∏±‡πà‡∏ô‡πÉ‡∏à ${pct}%)`;

    if(predList.childElementCount!==predictions.length){
      predList.innerHTML='';
      for(let i=0;i<predictions.length;i++){
        const row=document.createElement('div');
        row.className='pred';
        row.innerHTML=`<div class="name"></div><div class="bar"><span></span></div><div class="val"></div>`;
        predList.appendChild(row);
      }
    }
    [...predList.children].forEach((row,i)=>{
      const p=predictions[i];
      const percent=(p.probability*100).toFixed(1);
      row.querySelector('.name').textContent=p.className;
      row.querySelector('.bar > span').style.width=percent+'%';
      row.querySelector('.val').textContent=percent+'%';
    });

    if(best.probability>=0.6){
      playSoundForClass(best.className);
      checkPrediction(best.className);
    }
  }

 // =====================
// üéÆ ‡πÇ‡∏´‡∏°‡∏î‡πÅ‡∏Ç‡πà‡∏á‡∏Ç‡∏±‡∏ô 2 ‡∏Ñ‡∏ô
// =====================
let players = [
  {name: "Player 1", score: 0},
  {name: "Player 2", score: 0}
];
let currentPlayer = 0;   // ‡πÄ‡∏£‡∏¥‡πà‡∏°‡∏ó‡∏µ‡πà Player 1
let currentChallenge = "";
let roundTime = 20;
let timer;

document.getElementById("btnStartGame").addEventListener("click", startRound);

function startRound(){
  const classes = Object.keys(CLASS_SOUNDS); // ‡πÉ‡∏ä‡πâ‡∏ä‡∏∑‡πà‡∏≠ class ‡∏à‡∏≤‡∏Å‡πÇ‡∏°‡πÄ‡∏î‡∏•
  currentChallenge = classes[Math.floor(Math.random()*classes.length)];
  document.getElementById("challenge").textContent =
    `${players[currentPlayer].name} ‡πÇ‡∏à‡∏ó‡∏¢‡πå: ‡∏õ‡∏±‡πâ‡∏ô ${currentChallenge}`;

  roundTime = 20;
  clearInterval(timer);
  timer = setInterval(()=>{
    roundTime--;
    document.getElementById("time").textContent =
      "‡πÄ‡∏´‡∏•‡∏∑‡∏≠‡πÄ‡∏ß‡∏•‡∏≤: " + roundTime + " ‡∏ß‡∏¥ (‡∏ï‡∏≤‡∏Ç‡∏≠‡∏á " + players[currentPlayer].name + ")";
    if(roundTime <= 0){
      clearInterval(timer);
      nextTurn();
    }
  },1000);

  updateLeaderboard();
}

function nextTurn(){
  currentPlayer = (currentPlayer+1) % players.length; // ‡∏™‡∏•‡∏±‡∏ö‡∏ú‡∏π‡πâ‡πÄ‡∏•‡πà‡∏ô
  startRound();
}

function checkPrediction(label){
  if(label === currentChallenge){
    players[currentPlayer].score++;
    updateLeaderboard();
    clearInterval(timer);
    nextTurn();
  }
}

function updateLeaderboard(){
  let html = "<h4>üèÜ Leaderboard</h4>";
  players.forEach(p=>{
    html += `<div>${p.name}: ${p.score} ‡∏Ñ‡∏∞‡πÅ‡∏ô‡∏ô</div>`;
  });
  document.getElementById("leaderboard").innerHTML = html;
}

</script>
</body>
</html>
